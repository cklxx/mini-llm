# MiniLLM å…¨æµç¨‹å°å†Œå­

> æœ¬å°å†Œå­è¯¦ç»†è®°å½•äº† MiniLLM çš„å®Œæ•´è®­ç»ƒæµç¨‹ï¼šç¯å¢ƒåˆå§‹åŒ–ã€æ•°æ®å‡†å¤‡ã€RustBPE åˆ†è¯ã€åµŒå…¥ç”Ÿæˆã€é¢„è®­ç»ƒ (Pretrain)ã€ç›‘ç£å¾®è°ƒ (SFT) ä»¥åŠç›´æ¥åå¥½ä¼˜åŒ– (DPO)ã€‚å†…å®¹åŸºäº `scripts/run.sh` æä¾›çš„ä¸€é”®è„šæœ¬ï¼Œå¹¶è¡¥å……æ¯ä¸€æ­¥çš„åŸç†å’Œæ‰‹åŠ¨æ“ä½œæŒ‡å¼•ã€‚

> âš ï¸ **RustBPE ä¸ºå¯é€‰æµç¨‹**ï¼šåº”ç¤¾åŒºåé¦ˆï¼Œè„šæœ¬é»˜è®¤ä¸ä¼šæ„å»ºæˆ–è°ƒç”¨ RustBPEï¼›ä»…å½“è®¾ç½® `ENABLE_RUSTBPE=1` æ—¶æ‰ä¼šå¯ç”¨ç›¸å…³æ­¥éª¤ã€‚ä»¥ä¸‹ç« èŠ‚ä»ä¿ç•™ RustBPE çš„è¯¦ç»†è¯´æ˜ï¼Œä¾¿äºåç»­æ¥å…¥ã€‚

## 1. ä½¿ç”¨ pip åˆå§‹åŒ–ç¯å¢ƒ

1. **æ£€æµ‹ Python**ï¼šè„šæœ¬ä¼šè¯»å– `PYTHON` ç¯å¢ƒå˜é‡ï¼ˆç¼ºçœä¸º `python3`ï¼‰ï¼Œå¹¶æç¤ºæ­£åœ¨ä½¿ç”¨çš„è§£é‡Šå™¨ã€‚
2. **åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ**ï¼šé»˜è®¤åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.venv`ï¼Œé¿å…æ±¡æŸ“ç³»ç»Ÿç¯å¢ƒã€‚
3. **å®‰è£…ä¾èµ–**ï¼šé€šè¿‡ `pip install -r requirements.txt` å®‰è£…ä¾èµ–ï¼Œå¹¶åœ¨ `.venv/.deps_installed` å†™å…¥æ ‡è®°ã€‚ä¸‹æ¬¡æ‰§è¡Œæ—¶è‹¥æ£€æµ‹åˆ°æ ‡è®°åˆ™è·³è¿‡å®‰è£…ï¼Œæ»¡è¶³â€œç¯å¢ƒå‡†å¤‡å¥½åç›´æ¥è®­ç»ƒâ€çš„è¯‰æ±‚ã€‚
4. **ä¿ç•™ RustBPE å¯é€‰å…¥å£**ï¼šå¦‚éœ€å¯ç”¨ RustBPEï¼Œå¯æ‰‹åŠ¨æ‰§è¡Œ `pip install maturin` åè¿è¡Œ `ENABLE_RUSTBPE=1 bash scripts/run_cn_pipeline.sh`ï¼Œæ–°è„šæœ¬ä¿æŒé»˜è®¤å…³é—­ã€‚

> ğŸ“Œ *æ‰‹åŠ¨æ‰§è¡Œ*
>
> ```bash
> python3 -m venv .venv
> source .venv/bin/activate
> pip install --upgrade pip
> pip install -r requirements.txt
> ```

## 2. æ•°æ®å‡†å¤‡ä¸ä¸­å›½æºæ•°æ®é…æ¯”

é¡¹ç›®æ–°å¢ `scripts/build_chinese_mix.py`ï¼Œç”¨äºæŒ‰ç…§ nanochat çš„æ•°æ®é…æ¯”æ„å»ºä¸­æ–‡ä»»åŠ¡æ··åˆï¼š

| æ•°æ®ç±»åˆ« | é»˜è®¤æ•°é‡ | æ•°æ®æè¿° |
| --- | --- | --- |
| é€šç”¨å¯¹è¯ (`general`) | 460K | ä¾‹å¦‚ Belle, ShareGPT ä¸­æ–‡æ¸…æ´—åçš„å¤šè½®å¯¹è¯ |
| çŸ¥è¯†æµ‹è¯„ (`knowledge`) | 100K | ä¾‹å¦‚ CLUEã€CMMLU é€‰æ‹©é¢˜ï¼ˆè½¬åŒ–ä¸ºé—®ç­”ï¼‰ |
| æ•°å­¦æ¨ç† (`math`) | 8K | ä¾‹å¦‚ `math401` ä¸­æ–‡ç‰ˆæœ¬ã€CMath |
| èº«ä»½è®¤åŒ (`identity`) | 2 Ã— 1K | æå‡æ¨¡å‹äººè®¾ä¸è‡ªæˆ‘æè¿°èƒ½åŠ› |
| åå¥½å¯¹ (`preference`) | 60K | ä¾‹å¦‚ UltraFeedback ä¸­æ–‡å¢å¼ºæˆ–è‡ªå»ºåå¥½æ•°æ® |

è„šæœ¬ä¼šè‡ªåŠ¨è¯»å– `data/chinese/*.jsonl` ä¸­çš„æºæ•°æ®ï¼ˆå¦‚æœªæä¾›ä¼šä½¿ç”¨ç¤ºä¾‹æ ·æœ¬ï¼‰ï¼Œå¹¶è¾“å‡ºåˆ° `data/processed/`ï¼š

- `pretrain_chinese.jsonl`ï¼šç”¨äºé¢„è®­ç»ƒçš„ç»Ÿä¸€æ–‡æœ¬æ ¼å¼ã€‚
- `sft_chinese.jsonl`ï¼šç”¨äº SFT çš„ Chat æ ¼å¼ã€‚
- `dpo_chinese.jsonl`ï¼šç”¨äº DPO çš„åå¥½å¯¹æ ¼å¼ã€‚

> ğŸ“Œ *æ•°æ®åŠ è½½é€»è¾‘*
>
> - é‡‡ç”¨æƒ°æ€§è¿­ä»£å™¨é€è¡Œè¯»å– JSONLï¼Œé¿å…ä¸€æ¬¡æ€§å ç”¨å¤§é‡å†…å­˜ã€‚
> - æ¯ä¸ªç±»åˆ«ä¼šæ ¹æ®ç›®æ ‡æ•°é‡è‡ªåŠ¨æŠ½æ ·æˆ–é‡å¤é‡‡æ ·ï¼Œç¡®ä¿æ¯”ä¾‹ç¨³å®šã€‚
> - èº«ä»½è®¤åŒæ•°æ®é»˜è®¤é‡å¤ä¸¤æ¬¡ï¼Œæ¨¡ä»¿ nanochat åœ¨ mid-training ä¸ SFT ä¸­çš„åšæ³•ã€‚
> - ç»“æœå†™å…¥æ—¶ä¿ç•™åŸå­—æ®µï¼Œå¹¶é™„å¸¦ `source` æ ‡ç­¾æ–¹ä¾¿è¿½æº¯ã€‚

## 3. RustBPE åˆ†è¯ä¸è¯è¡¨è®­ç»ƒ

`scripts/train_rustbpe_tokenizer.py` å¤åˆ» nanochat çš„ RustBPE å·¥ä½œæµï¼š

1. **è¾“å…¥ç®¡çº¿**ï¼šæ”¯æŒ `pretrain`ã€`sft`ã€`dpo` ä¸‰ç§æ•°æ®æ ¼å¼ã€‚è„šæœ¬ä¼šè‡ªåŠ¨æŠŠ JSONL æ ·æœ¬è½¬æ¢ä¸ºçº¯æ–‡æœ¬åºåˆ—ï¼Œä¼ ç»™ RustBPEã€‚
2. **è¯è¡¨è§„æ¨¡**ï¼šé»˜è®¤ 6,400ï¼ˆæ‰£é™¤ç‰¹æ®Šç¬¦å·åæ»¡è¶³ RustBPE è‡³å°‘ 256 åŸºç¡€è¯å…ƒçš„çº¦æŸï¼‰ã€‚
3. **æ¨¡å‹å¯¼å‡º**ï¼šç”Ÿæˆ `tokenizer.pkl` å’Œ `tokenizer_meta.json`ï¼ŒåŒ…å«åˆ†è¯æ¨¡å¼ã€ç‰¹æ®Šç¬¦å·ä¸è¯è¡¨ç»Ÿè®¡ã€‚

> ğŸ“Œ *è®­ç»ƒåŸç†*
>
> - RustBPE ä¼šå…ˆæŒ‰ç…§ GPT-4 çš„æ­£åˆ™æ¨¡å¼ (`SPLIT_PATTERN`) åˆ‡åˆ†æ–‡æœ¬ï¼Œå†å¹¶è¡Œæ‰§è¡Œ BPE ç»Ÿè®¡å’Œåˆå¹¶ã€‚
> - ç”Ÿæˆçš„ `mergeable_ranks` ä¼šä¸ç‰¹æ®Šç¬¦å·ç»“åˆï¼Œäº¤ç”± tiktoken æ‰§è¡Œå¿«é€Ÿæ¨ç†ã€‚
> - è®­ç»ƒå®Œæˆçš„ `RustBPETokenizer` æ”¯æŒ `encode`ã€`decode`ã€`render_conversation` ç­‰æ¥å£ï¼Œæ–¹ä¾¿åç»­ä»»åŠ¡ã€‚

## 4. å°†æ•°æ®è½¬æ¢ä¸ºåµŒå…¥ (Embedding) è¡¨ç¤º

`scripts/export_embeddings.py` æä¾›ç»Ÿä¸€çš„æ•°æ® -> token/åµŒå…¥æµç¨‹ï¼š

1. **é¢„è®­ç»ƒ (`pretrain`)**ï¼š
   - ä¸ºæ¯ä¸ªæ–‡æœ¬æ·»åŠ  `<|bos|>` èµ·å§‹ç¬¦ã€‚
   - è¾“å‡º `(input_ids, labels)`ï¼Œå¹¶å†™å…¥ `Torch` å¼ é‡æ–‡ä»¶ï¼Œé»˜è®¤ 2048 åºåˆ—é•¿åº¦ã€‚

2. **SFT (`sft`)**ï¼š
   - ä½¿ç”¨ `RustBPETokenizer.render_conversation` æ¸²æŸ“å¯¹è¯ï¼Œå°† `<|user_start|>` / `<|assistant_start|>` ç­‰æ ‡ç­¾æ’å…¥ã€‚
   - åŒæ—¶ç”Ÿæˆ `loss_mask`ï¼Œä»…å¯¹åŠ©æ‰‹å›å¤éƒ¨åˆ†è®¡ç®—æŸå¤±ã€‚

3. **DPO (`dpo`)**ï¼š
   - å¯¹ `chosen` ä¸ `rejected` ä¸¤æ¡å¯¹è¯åˆ†åˆ«æ¸²æŸ“ï¼Œä¿å­˜ä¸ºæˆå¯¹çš„ `input_ids`/`loss_mask`ã€‚

> ğŸ“Œ *æ³¨æ„äº‹é¡¹*
>
> - æ‰€æœ‰å¼ é‡å‡ä¿å­˜ä¸ºåŠç²¾åº¦å…¼å®¹çš„ `torch.int32` / `torch.int64`ï¼Œä¾¿äºç›´æ¥åŠ è½½åˆ° DataLoader ä¸­ã€‚
> - `--max-length` æ§åˆ¶æˆªæ–­ä¸å¡«å……é•¿åº¦ï¼Œé»˜è®¤ 2048ï¼›è„šæœ¬ä¼šåœ¨è¶…å‡ºé•¿åº¦æ—¶å‘å‡ºè­¦å‘Šã€‚
> - é€šè¿‡ `--bos-token`ã€`--append-eos` ç­‰å‚æ•°å¯è‡ªå®šä¹‰ç‰¹æ®Šç¬¦å·å¤„ç†ã€‚

## 5. é»˜è®¤è®­ç»ƒé…ç½®

- `hidden_size = 512`
- `num_hidden_layers = 8`
- `num_attention_heads = 8`
- `vocab_size = 6400`

è¯¥ç»„åˆä¸ä»“åº“å†å²ç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼Œ`trainer/train_*.py` é»˜è®¤é‡‡ç”¨è¿™ä¸€é…ç½®ã€‚è„šæœ¬ä¼šæ‰“å°æ¨¡å‹å¯è®­ç»ƒå‚æ•°é‡ï¼Œæ–¹ä¾¿æ£€æŸ¥ã€‚

## 6. ä¸€é”®è¿è¡Œè„šæœ¬

`scripts/run.sh` ä¸²è”ä¸Šè¿°æ­¥éª¤ï¼Œå®Œæˆä»¥ä¸‹å·¥ä½œï¼š

1. ç¯å¢ƒåˆå§‹åŒ–ï¼ˆpip + venvï¼‰å¹¶å…¼å®¹ `PYTHON`/`VENV_DIR` è‡ªå®šä¹‰ï¼›
2. æ„å»ºä¸­æ–‡æ•°æ®æ··åˆ (`build_chinese_mix.py`)ï¼ŒåŒæ—¶ç¡®è®¤ `data/chinese/identity_conversations.jsonl` å­˜åœ¨ï¼›
3. ä¾æ¬¡è¿è¡Œé¢„è®­ç»ƒï¼ˆ2 epochï¼‰ã€SFTã€DPOï¼Œä¸‰é˜¶æ®µå‡ä½¿ç”¨é»˜è®¤é…ç½®ï¼›
4. æ¯ä¸ªé˜¶æ®µç»“æŸåè°ƒç”¨ `scripts/evaluate_stage.py` è¿›è¡Œå¿«é€ŸéªŒè¯ï¼Œåœ¨ç»ˆç«¯æ‰“å°åˆ†æ•°å¹¶æŠŠ JSON ç»“æœè¿½åŠ å†™å…¥ `../tf_dir/eval_results.jsonl`ï¼›
5. ä¿æŒ `PRETRAIN_ARGS` / `SFT_ARGS` / `DPO_ARGS` ç¯å¢ƒå˜é‡ä½œä¸ºé¢å¤–å‚æ•°é€šé“ï¼Œæ–¹ä¾¿è‡ªå®šä¹‰ batch sizeã€å­¦ä¹ ç‡ç­‰è®­ç»ƒç»†èŠ‚ã€‚

è„šæœ¬é»˜è®¤è¾“å‡ºæƒé‡åˆ° `out/`ï¼Œå¹¶è‡ªåŠ¨åˆ›å»ºä¸Šä¸€çº§ç›®å½•ä¸­çš„ `tf_dir/` ä»¥å…¼å®¹å†å²æµæ°´çº¿ã€‚å¦‚æœå¸Œæœ›é‡ç”¨ uv æ–¹æ¡ˆï¼Œä»å¯è¿è¡Œ `bash scripts/run_cn_pipeline.sh`ï¼Œå¹¶æŒ‰ç…§ä¸Šä¸€èŠ‚è¯´æ˜æ‰‹åŠ¨å®‰è£… `maturin` åå¼€å¯ RustBPEã€‚

> ğŸ’¡ **æœ¬åœ° CPU å†’çƒŸæµ‹è¯•**ï¼šè¿è¡Œ `bash scripts/run.sh --smoke-test`ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨è£å‰ª JSONL æ•°æ®ã€æ”¹ç”¨ CPU + float32ï¼Œå¹¶é™åˆ¶æ¯é˜¶æ®µä»…æ‰§è¡Œæ•°ä¸ªè¿­ä»£ï¼Œå‡ åˆ†é’Ÿå†…å³å¯éªŒè¯æ•´æ¡æµæ°´çº¿æ˜¯å¦å¯ç”¨ã€‚

## 7. èº«ä»½è®¤åŒæ•°æ®

- åœ¨ `dataset/identity_cn_sample.jsonl` ä¸­æä¾›ç¤ºä¾‹å¯¹è¯ï¼ŒçœŸå®åœºæ™¯è¯·æ›¿æ¢ä¸ºè‡ªå®šä¹‰èº«ä»½è®¾å®šç”Ÿæˆçš„æ•°æ®ã€‚
- æ„å»ºè„šæœ¬ä¼šè‡ªåŠ¨ä¸‹è½½/å¼•ç”¨ `identity_conversations.jsonl`ï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼Œå¹¶åœ¨ mid-training/SFT é˜¶æ®µé‡å¤é‡‡æ ·ä¸¤éã€‚
- ä½ å¯ä»¥æŒ‰ç…§ [nanochat èº«ä»½å®šåˆ¶æŒ‡å—](https://github.com/karpathy/nanochat/discussions/139) ç”Ÿæˆæ›´å¤šä¸­æ–‡èº«ä»½æ•°æ®ï¼Œç„¶åæ”¾ç½®åœ¨ `data/chinese/identity_conversations.jsonl`ã€‚

## 8. æ‰‹åŠ¨æ‰§è¡Œæç¤º

- **ä»…é¢„è®­ç»ƒé˜¶æ®µ**ï¼šè¿è¡Œ `python trainer/train_pretrain.py --data_path data/processed/pretrain_chinese.jsonl`ã€‚
- **ä»… SFT é˜¶æ®µ**ï¼šç¡®è®¤é¢„è®­ç»ƒæƒé‡å­˜åœ¨åï¼Œæ‰§è¡Œ `python trainer/train_full_sft.py --data_path data/processed/sft_chinese.jsonl`ã€‚
- **ä»… DPO é˜¶æ®µ**ï¼š`python trainer/train_dpo.py --data_path data/processed/dpo_chinese.jsonl`ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨åŠ è½½æœ€æ–°çš„ SFT æƒé‡ã€‚

## 9. å¸¸è§é—®é¢˜

1. **rustbpe æ— æ³•å¯¼å…¥**ï¼šç¡®è®¤å·²è®¾ç½® `ENABLE_RUSTBPE=1` å¹¶æ‰§è¡Œ `uv tool install maturin`ï¼Œéšåè¿è¡Œ `uv run maturin develop --release --manifest-path rustbpe/Cargo.toml`ï¼Œç¡®ä¿åœ¨åŒä¸€è™šæ‹Ÿç¯å¢ƒä¸‹æ‰§è¡Œ Pythonã€‚
2. **æ•°æ®é›†å¤ªå°å¯¼è‡´æŠ½æ ·å¤±è´¥**ï¼š`build_chinese_mix.py` ä¼šåœ¨æ•°æ®ä¸è¶³æ—¶å¾ªç¯é‡‡æ ·ï¼Œä»å»ºè®®æä¾›è¶³å¤Ÿè¯­æ–™ã€‚
3. **åºåˆ—è¿‡é•¿è¢«æˆªæ–­**ï¼šåœ¨ `export_embeddings.py` ä¸­è°ƒæ•´ `--max-length` æˆ–åœ¨æ„å»ºæ•°æ®é›†æ—¶è¿›è¡Œé¢„æˆªæ–­ã€‚
4. **GPU æ˜¾å­˜ä¸è¶³**ï¼šé™ä½ `--batch_size` æˆ–å¢åŠ  `--accumulation_steps`ï¼›è„šæœ¬é»˜è®¤å¯ç”¨æ¢¯åº¦ç´¯ç§¯ã€‚

---

é€šè¿‡æœ¬å°å†Œå­ï¼Œä½ å¯ä»¥å¿«é€Ÿäº†è§£å¹¶å¤ç° MiniLLM åœ¨ä¸­æ–‡è¯­å¢ƒä¸‹çš„å®Œæ•´è®­ç»ƒä¸è°ƒä¼˜æµç¨‹ï¼Œä¹Ÿå¯ä»¥åœ¨æ¯ä¸ªé˜¶æ®µè¿›è¡Œä¸ªæ€§åŒ–å®šåˆ¶ã€‚
