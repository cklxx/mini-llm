# Mac优化预训练指南

## 🎯 项目目标

通过使用最少的数据量快速验证模型智能效果，同时限制CPU和GPU使用，避免Mac卡死。

## 📊 优化方案概述

### 数据量优化
- **训练数据集**: `pretrain_200.jsonl` (200条高质量对话)  
- **测试数据集**: `pretrain_test.jsonl` (30条验证数据)
- **涵盖领域**: 问答、创意生成、技术咨询、文本分析等

### 模型规模对比

| 配置 | 参数量 | 内存需求 | 训练时间 | 适用场景 |
|------|--------|----------|----------|----------|
| Tiny | ~13K | ~0.2MB | 10-20分钟 | 快速验证智能效果 |
| Small | ~66K | ~0.8MB | 30-45分钟 | 平衡性能与智能 |
| Original | ~2.5M | ~30MB | 数小时 | 完整训练 |

### 资源限制
- **CPU使用率**: ≤70% (可调整)
- **内存使用率**: ≤60% (可调整)
- **自动暂停**: 资源超限时自动暂停训练
- **优雅退出**: Ctrl+C安全停止

## 🚀 快速开始

### 1. 环境准备

#### 方式一：使用UV环境管理（推荐）
```bash
# 一键设置UV环境
./setup_uv.sh

# 激活环境
source .venv/bin/activate

# 使用UV快速启动
python quick_start_uv.py
```

#### 方式二：传统pip安装
```bash
# 确保已安装依赖
pip install torch psutil

# 检查Python路径
python3 -c "import sys; print(sys.path)"
```

### 2. 测试配置

```bash
# 测试Mac优化配置
python config/mac_optimized_config.py
```

预期输出:
```
=== Mac优化配置测试 ===
系统信息: {'platform': 'Darwin-24.5.0', 'cpu_count': 8, 'memory_gb': 16.0, 'available_memory_gb': 8.5}

Tiny模型信息:
  参数量: 13,568
  内存需求: 0.2MB

✅ 配置验证通过

当前资源使用:
  CPU: 15.2%
  内存: 45.8%
```

### 3. 开始训练

#### 超小模型训练 (推荐首次使用)
```bash
# UV环境
python quick_start_uv.py

# 或直接训练
python scripts/train_optimized.py --config tiny
```

#### 小模型训练
```bash
# UV环境
python quick_start_uv.py

# 或直接训练  
python scripts/train_optimized.py --config small
```

#### 自定义资源限制
```bash
python scripts/train_optimized.py --config tiny --max-cpu 50 --max-memory 40
```

## 📈 训练过程示例

```
============================================================
🚀 Mac优化训练 - 智能效果验证
============================================================
系统平台: macOS-14.5-arm64-arm-64bit
CPU核心数: 8
总内存: 16.0GB
可用内存: 8.5GB

📊 模型信息:
预估参数量: 13,568
模型内存: 0.2MB
训练内存: 0.6MB

⚙️  训练配置:
数据文件: ['pretrain_minimal.jsonl']
批次大小: 4
最大步数: 200
学习率: 0.001
设备: cpu
------------------------------------------------------------

🔍 启动资源监控...
🔧 设置分词器...
从 50 条文本训练分词器...
分词器已保存: checkpoints/mac_tiny/tokenizer.pkl
词汇表大小: 2000

📚 设置数据加载器...
加载 50 条训练文本
数据批次数: 13

🧠 创建模型...
使用设备: cpu
总参数量: 13,568
可训练参数: 13,568

🏃 开始训练...
步骤   10 | 轮次  0 | 损失 8.2156 | 平均损失 8.7234 | 速度 2.3 steps/s
步骤   20 | 轮次  1 | 损失 7.8945 | 平均损失 8.1234 | 速度 2.5 steps/s

🧪 生成测试 - 输入: '你好，'
🤖 生成结果: '你好，我想学习编程，有什么建议吗？'

💻 资源状态 - CPU: 45.2%, 内存: 52.1%
```

## 🎯 智能效果验证指标

### 1. 损失下降趋势
- **初始损失**: 8-10 (随机状态)
- **收敛目标**: 2-4 (开始显示智能)
- **良好状态**: <2 (较好的智能效果)

### 2. 生成质量评估
训练过程中会定期进行生成测试：
```
输入: "你好，"
期望输出: 有意义的回应，如"你好！有什么可以帮助你的吗？"
```

### 3. 训练进度指标
- **步骤/秒**: 2-5 (正常范围)
- **内存使用**: 稳定，无明显增长
- **CPU使用**: 在限制范围内

## 🔧 故障排除

### 问题1: 导入错误
```
ModuleNotFoundError: No module named 'src.model'
```
**解决方案**:
```bash
# 确保在项目根目录运行
cd /path/to/minigpt-training
python scripts/train_optimized.py --config tiny
```

### 问题2: 资源不足
```
⚠️  资源使用过高，暂停训练:
   CPU: 75.1% (限制: 70.0%)
```
**解决方案**:
- 降低资源限制: `--max-cpu 80 --max-memory 70`
- 减小批次大小 (自动调整)
- 关闭其他应用程序

### 问题3: 训练卡住
- 按 `Ctrl+C` 安全退出
- 检查 `checkpoints/mac_tiny/` 目录下的保存点
- 重新启动训练会自动加载已训练的分词器

### 问题4: 生成效果差
- **原因**: 训练步数不足或数据质量问题
- **解决**: 增加训练步数到500-1000步
- **调整学习率**: 尝试 `1e-4` 到 `5e-3` 范围

## 🎨 自定义配置

### 创建自定义数据集
```python
# 创建你的数据文件: data/dataset/minimind_dataset/my_data.jsonl
{"text": "<|im_start|>你的问题<|im_end|> <|im_start|>对应回答<|im_end|>"}
```

### 修改模型配置
```python
# 在 config/mac_optimized_config.py 中调整
config.model.d_model = 128      # 增加模型容量
config.pretrain.max_steps = 500  # 延长训练时间
```

## 📋 最佳实践

### 1. 训练策略
1. **从tiny开始**: 先用tiny配置验证环境和数据
2. **观察损失**: 损失应该持续下降
3. **检查生成**: 每25步查看生成效果
4. **逐步升级**: tiny→small→medium

### 2. 资源管理
- 训练前关闭不必要应用
- 使用Activity Monitor监控系统资源
- 设置合理的资源限制阈值

### 3. 数据质量
- 确保数据格式正确
- 平衡不同类型的对话
- 避免重复或低质量内容

## 📚 进阶使用

### 继续训练
```bash
# 模型会自动加载已保存的检查点
python scripts/train_optimized.py --config tiny
```

### 生成测试
```bash
# 使用训练好的模型进行生成
python scripts/generate.py --model checkpoints/mac_tiny/final_model.pt
```

### 模型评估
```bash
# 评估模型性能
python scripts/evaluate.py --model checkpoints/mac_tiny/final_model.pt
```

## ⚡ 性能对比

| 操作 | 原始配置 | Mac优化配置 | 改善比例 |
|------|----------|-------------|----------|
| 数据加载时间 | 30分钟 | 1分钟 | 30x |
| 单步训练时间 | 5秒 | 0.4秒 | 12.5x |
| 内存占用 | 4-8GB | 0.5-1GB | 8x |
| 收敛步数 | 10000+ | 100-500 | 20x |

## 🏆 成功标准

一个成功的训练应该具备：

1. **损失收敛**: 从8-10降至2-4
2. **生成合理**: 能产生有意义的回应
3. **资源稳定**: CPU/内存使用稳定
4. **无崩溃**: 完整运行200步无错误

达到这些标准说明模型已经开始展现智能效果，可以考虑：
- 增加训练数据量
- 使用更大的模型配置
- 进行后续的SFT/DPO训练

## 📞 支持与反馈

如果遇到问题或有改进建议，请：
1. 检查本文档的故障排除部分
2. 查看终端输出的详细错误信息
3. 记录系统配置和运行日志 